<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>두쫀쿠 서바이버: 하이퍼</title>
    <style>
        /* 확대 및 스크롤 완전 방지 */
        * { touch-action: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; }
        canvas { display: block; }

        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .class-list { display: flex; gap: 15px; margin-top: 20px; }
        .class-card { background: #222; border: 2px solid #444; border-radius: 12px; padding: 15px; width: 140px; text-align: center; cursor: pointer; }
        .class-card:active { transform: scale(0.95); border-color: #00ffcc; }

        #ui-top { position: absolute; top: 15px; left: 20px; color: white; pointer-events: none; z-index: 10; }
        #stage-info { font-size: 20px; color: #ffee00; font-weight: bold; }
        #exp-bar { width: 200px; height: 8px; background: #333; border: 1px solid #fff; margin-top: 5px; }
        #exp-inner { width: 0%; height: 100%; background: #00ccff; }

        #joy-base { position: absolute; bottom: 40px; left: 50px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(0,255,204,0.4); border-radius: 50%; }
        
        #ult-btn { 
            position: absolute; bottom: 45px; right: 60px; width: 85px; height: 85px; 
            background: rgba(255,68,68,0.1); border: 4px solid #ff4444; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;
            opacity: 0.3; transition: 0.1s;
        }
        #ult-btn.ready { opacity: 1; background: #ff4444; box-shadow: 0 0 20px #ff4444; }

        #level-up-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; gap: 15px; }
        .skill-card { background: #222; color: white; padding: 20px; width: 180px; border: 2px solid #00ffcc; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1>클래스 선택</h1>
        <div class="class-list">
            <div class="class-card" onclick="startGame('warrior')"><h3>전사</h3><p>근접 광역</p></div>
            <div class="class-card" onclick="startGame('archer')"><h3>궁수</h3><p>빠른 연사</p></div>
            <div class="class-card" onclick="startGame('wizard')"><h3>마법사</h3><p>강력한 폭발</p></div>
        </div>
    </div>

    <div id="ui-top">
        <div id="stage-info">STAGE <span id="cur-stage">1</span> (<span id="kill-count">0</span> / 100)</div>
        <div id="exp-bar"><div id="exp-inner"></div></div>
    </div>

    <div id="level-up-ui">
        <div class="skill-card" onclick="selectSkill('dmg')">공격력 강화</div>
        <div class="skill-card" onclick="selectSkill('spd')">이동속도 강화</div>
        <div class="skill-card" onclick="selectSkill('fire')">연사속도 강화</div>
    </div>

    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="ult-btn">ULTIMATE</div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let stage = 1, lv = 1, exp = 0, expNext = 5, totalKills = 0, stageKills = 0, isPaused = true, ultGauge = 0;
        let killGoal = 100;
        
        const classData = {
            warrior: { name: 'Warrior', size: 10, hp: 200, spd: 3.5, range: 70, fireRate: 500, color: '#00ffcc' },
            archer: { name: 'Archer', size: 8, hp: 100, spd: 5, range: 300, fireRate: 350, color: '#ffee00' },
            wizard: { name: 'Wizard', size: 8, hp: 80, spd: 3, range: 450, fireRate: 1000, color: '#ff00ff' }
        };

        let pClass = null;
        let lastAngle = 0; // 마지막 이동 방향 기억
        const player = { x: 0, y: 0 };
        const camera = { x: 0, y: 0 };
        const enemies = [], bullets = [], orbs = [];
        let moveX = 0, moveY = 0, isJoy = false;

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        // 확대 방지용 이벤트 리스너 (강력 조치)
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });

        const ultBtn = document.getElementById('ult-btn');
        ultBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // 연타 시 확대 방지
            if (ultGauge < 100) return;
            ultGauge = 0;
            ultBtn.classList.remove('ready');
            enemies.forEach(e => e.hp -= 100);
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        function startGame(type) {
            pClass = { ...classData[type] };
            document.getElementById('start-screen').style.display = 'none';
            isPaused = false;
            loop();
        }

        const joyBase = document.getElementById('joy-base');
        const joyStick = document.getElementById('joy-stick');
        const updateJoy = (e) => {
            if (!isJoy) return;
            const t = e.touches ? e.touches[0] : e;
            const r = joyBase.getBoundingClientRect();
            const dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const dist = Math.min(Math.sqrt(dx * dx + dy * dy), 50);
            const ang = Math.atan2(dy, dx);
            if (dist > 10) lastAngle = ang; // 이동 방향 업데이트
            const sx = Math.cos(ang) * dist, sy = Math.sin(ang) * dist;
            joyStick.style.transform = `translate(${sx}px, ${sy}px)`;
            moveX = sx / 50; moveY = sy / 50;
        };
        joyBase.addEventListener('touchstart', (e) => { e.preventDefault(); isJoy = true; });
        window.addEventListener('touchmove', (e) => { if (isJoy) updateJoy(e); });
        window.addEventListener('touchend', () => { isJoy = false; moveX = 0; moveY = 0; joyStick.style.transform = 'translate(0,0)'; });

        function selectSkill(type) {
            if (type === 'dmg') pClass.range += 20;
            if (type === 'spd') pClass.spd += 0.5;
            if (type === 'fire') pClass.fireRate *= 0.85;
            isPaused = false;
            document.getElementById('level-up-ui').style.display = 'none';
        }

        let lastShot = 0;
        function update() {
            if (isPaused) return;
            player.x += moveX * pClass.spd;
            player.y += moveY * pClass.spd;
            camera.x = player.x - canvas.width / 2;
            camera.y = player.y - canvas.height / 2;

            // 스테이지 관리
            if (stageKills >= killGoal) {
                stage++;
                stageKills = 0;
                if (stage === 2) killGoal = 300;
                if (stage === 3) killGoal = 500;
                document.getElementById('cur-stage').innerText = stage;
            }
            document.getElementById('kill-count').innerText = stageKills;

            // 적 스폰 (난이도 급상승)
            const maxEnemies = 15 + (stage * 15);
            if (enemies.length < maxEnemies) {
                const ang = Math.random() * Math.PI * 2;
                enemies.push({
                    x: player.x + Math.cos(ang) * 600,
                    y: player.y + Math.sin(ang) * 600,
                    hp: 1 + (stage * 0.8),
                    speed: 1.2 + (stage * 0.4) + Math.random(), // 몹 속도 상향
                    size: 7,
                    color: `hsl(${stage * 50 % 360}, 70%, 50%)`
                });
            }

            // 공격 로직 (이동 방향 우선 조준)
            if (Date.now() - lastShot > pClass.fireRate) {
                let targetAng = lastAngle;
                const nearEnemy = enemies.find(e => Math.hypot(e.x - player.x, e.y - player.y) < pClass.range);
                
                if (nearEnemy) {
                    targetAng = Math.atan2(nearEnemy.y - player.y, nearEnemy.x - player.x);
                }

                if (pClass.name === 'Warrior') {
                    enemies.forEach(e => {
                        if (Math.hypot(e.x - player.x, e.y - player.y) < pClass.range) e.hp -= 2;
                    });
                } else {
                    bullets.push({ 
                        x: player.x, y: player.y, 
                        vx: Math.cos(targetAng) * 10, vy: Math.sin(targetAng) * 10, 
                        size: pClass.name === 'Wizard' ? 12 : 3 
                    });
                }
                lastShot = Date.now();
            }

            enemies.forEach((e, ei) => {
                const ang = Math.atan2(player.y - e.y, player.x - e.x);
                e.x += Math.cos(ang) * e.speed;
                e.y += Math.sin(ang) * e.speed;

                bullets.forEach((b, bi) => {
                    if (Math.hypot(b.x - e.x, b.y - e.y) < e.size + b.size) {
                        e.hp -= 1; bullets.splice(bi, 1);
                    }
                });

                if (e.hp <= 0) {
                    orbs.push({ x: e.x, y: e.y });
                    stageKills++;
                    ultGauge = Math.min(100, ultGauge + 1.5);
                    if (ultGauge >= 100) ultBtn.classList.add('ready');
                    enemies.splice(ei, 1);
                }
            });

            orbs.forEach((o, oi) => {
                if (Math.hypot(player.x - o.x, player.y - o.y) < 40) {
                    orbs.splice(oi, 1); exp++;
                    if (exp >= expNext) {
                        lv++; exp = 0; expNext += 5; isPaused = true;
                        document.getElementById('level-up-ui').style.display = 'flex';
                    }
                    document.getElementById('exp-inner').style.width = (exp / expNext * 100) + "%";
                }
            });

            bullets.forEach((b, i) => { 
                b.x += b.vx; b.y += b.vy; 
                if (Math.hypot(b.x - player.x, b.y - player.y) > 800) bullets.splice(i, 1); 
            });
        }

        function draw() {
            ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#151515';
            for (let x = -camera.x % 100; x < canvas.width; x += 100) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); }
            for (let y = -camera.y % 100; y < canvas.height; y += 100) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }

            orbs.forEach(o => { ctx.fillStyle = '#00ccff'; ctx.beginPath(); ctx.arc(o.x - camera.x, o.y - camera.y, 2, 0, Math.PI * 2); ctx.fill(); });
            enemies.forEach(e => { ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(e.x - camera.x, e.y - camera.y, e.size, 0, Math.PI * 2); ctx.fill(); });
            bullets.forEach(b => { ctx.fillStyle = '#ffee00'; ctx.beginPath(); ctx.arc(b.x - camera.x, b.y - camera.y, b.size, 0, Math.PI * 2); ctx.fill(); });
            
            ctx.fillStyle = pClass.color;
            ctx.beginPath(); ctx.arc(canvas.width / 2, canvas.height / 2, pClass.size, 0, Math.PI * 2); ctx.fill();
            
            // 전사 가이드라인
            if (pClass.name === 'Warrior') {
                ctx.strokeStyle = 'rgba(0,255,204,0.1)'; ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, pClass.range, 0, Math.PI*2); ctx.stroke();
            }
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
    </script>
</body>
</html>

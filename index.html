<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DooJjonKu Survivors</title>
    <style>
        /* 고딕체 통일 및 기본 설정 */
        * { 
            touch-action: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; 
            font-family: 'Pretendard', 'Nanum Gothic', 'Malgun Gothic', sans-serif;
        }
        body { margin: 0; overflow: hidden; background: #0a0a0a; color: white; }
        canvas { display: block; }

        /* UI 레이아웃 */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; padding: 20px; }
        #top-info { display: flex; justify-content: space-between; align-items: flex-start; }
        .bar-group { display: flex; flex-direction: column; gap: 8px; }
        .bar-container { width: 160px; height: 12px; background: rgba(255,255,255,0.1); border: 1px solid #555; border-radius: 6px; overflow: hidden; }
        #hp-bar { height: 100%; background: linear-gradient(90deg, #ff4d4d, #ff8080); width: 100%; transition: 0.2s; }
        #mp-bar { height: 100%; background: linear-gradient(90deg, #00d4ff, #00f2ff); width: 0%; transition: 0.2s; }
        
        #kill-display { font-size: 24px; font-weight: 800; color: #ffee00; text-shadow: 2px 2px 0px #000; }
        #stage-text { font-size: 14px; opacity: 0.8; margin-top: 5px; }

        /* 클래스 선택창 */
        #selector { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; }
        .btn { background: #222; border: 2px solid #444; padding: 15px; border-radius: 12px; color: white; cursor: pointer; text-align: center; width: 110px; transition: 0.2s; pointer-events: auto; }
        .btn:active { transform: scale(0.9); border-color: #00ffcc; }

        /* 컨트롤러 */
        #joystick-base { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        #joystick-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(0,255,204,0.4); border-radius: 50%; pointer-events: none; }
        #ult-btn { position: absolute; bottom: 45px; right: 45px; width: 85px; height: 85px; background: rgba(255,215,0,0.1); border: 3px solid gold; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; color: gold; opacity: 0.3; pointer-events: auto; }
        #ult-btn.ready { opacity: 1; box-shadow: 0 0 20px gold; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="selector">
        <h1 style="letter-spacing: -1px;">DooJjonKu Survivors</h1>
        <p style="opacity: 0.6;">캐릭터를 선택하여 생존을 시작하세요</p>
        <div class="grid">
            <div class="btn" onclick="init('knight')">검사</div>
            <div class="btn" onclick="init('ranger')">궁수</div>
            <div class="btn" onclick="init('mage')">마법사</div>
        </div>
    </div>

    <div id="ui-layer">
        <div id="top-info">
            <div class="bar-group">
                <div class="bar-container"><div id="hp-bar"></div></div>
                <div class="bar-container"><div id="mp-bar"></div></div>
                <div id="stage-text">STAGE 1 - 심리스 모드</div>
            </div>
            <div id="kill-display">000</div>
        </div>
        <div id="joystick-base"><div id="joystick-stick"></div></div>
        <div id="ult-btn">ULT</div>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let stage = 1, kills = 0, mp = 0, hp = 100, isLive = false;
        let player, camera, enemies = [], particles = [], chests = [], items = [], bullets = [];
        let moveX = 0, moveY = 0, isTouch = false, lastDir = 0;

        const classes = {
            knight: { color: '#00ffcc', spd: 2, range: 60, effect: 'cyan' },
            ranger: { color: '#ffea00', spd: 2.8, range: 240, effect: 'yellow' },
            mage: { color: '#bf00ff', spd: 1.6, range: 350, effect: 'purple' }
        };

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        function init(type) {
            player = { x: 0, y: 0, ...classes[type], type, size: 10 };
            camera = { x: 0, y: 0 };
            document.getElementById('selector').style.display = 'none';
            isLive = true;
            loop();
        }

        // --- 조이스틱 제어 ---
        const jBase = document.getElementById('joystick-base');
        const jStick = document.getElementById('joystick-stick');
        jBase.addEventListener('touchstart', (e) => { e.preventDefault(); isTouch = true; });
        window.addEventListener('touchmove', (e) => {
            if(!isTouch) return;
            const t = e.touches[0];
            const r = jBase.getBoundingClientRect();
            const dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 50);
            const ang = Math.atan2(dy, dx);
            lastDir = ang;
            jStick.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
            moveX = (Math.cos(ang)*dist)/50; moveY = (Math.sin(ang)*dist)/50;
        });
        window.addEventListener('touchend', () => { isTouch = false; moveX = 0; moveY = 0; jStick.style.transform = 'translate(0,0)'; });

        // --- 파티클 시스템 ---
        function spawnPart(x, y, color) {
            for(let i=0; i<5; i++) {
                particles.push({x, y, vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4, life: 20, color});
            }
        }

        function update() {
            if(!isLive) return;
            player.x += moveX * player.spd;
            player.y += moveY * player.spd;
            camera.x = player.x - canvas.width/2;
            camera.y = player.y - canvas.height/2;

            // 스테이지 자연 자동 전환 (100킬 단위)
            stage = Math.floor(kills / 100) + 1;
            document.getElementById('stage-text').innerText = `STAGE ${stage} - ${kills%100}/100`;

            // 몹 생성 (천천히 걷기)
            if(enemies.length < 20 + stage*5) {
                const a = Math.random()*Math.PI*2;
                enemies.push({ x: player.x + Math.cos(a)*600, y: player.y + Math.sin(a)*600, hp: stage, spd: 0.4 + stage*0.1 });
            }

            // 상자 생성 및 상호작용
            if(Math.random() < 0.003 && chests.length < 5) {
                chests.push({ x: player.x + (Math.random()-0.5)*1000, y: player.y + (Math.random()-0.5)*1000, open: false });
            }
            chests.forEach((c, i) => {
                if(!c.open && Math.hypot(player.x-c.x, player.y-c.y) < 50) {
                    c.open = true;
                    items.push({ x: c.x, y: c.y, type: Math.random() > 0.5 ? 'HP' : 'MP' });
                    spawnPart(c.x, c.y, 'gold');
                }
            });

            // 적 AI 및 충돌
            enemies.forEach((e, i) => {
                const ang = Math.atan2(player.y-e.y, player.x-e.x);
                e.x += Math.cos(ang) * e.spd;
                e.y += Math.sin(ang) * e.spd;
                if(Math.hypot(player.x-e.x, player.y-e.y) < 15) hp -= 0.1;
                
                bullets.forEach((b, bi) => {
                    if(Math.hypot(b.x-e.x, b.y-e.y) < 15) {
                        e.hp--; bullets.splice(bi, 1);
                        spawnPart(e.x, e.y, player.effect);
                    }
                });
                if(e.hp <= 0) { enemies.splice(i, 1); kills++; mp = Math.min(100, mp+1.5); }
            });

            // 아이템 획득
            items.forEach((it, i) => {
                if(Math.hypot(player.x-it.x, player.y-it.y) < 20) {
                    if(it.type === 'HP') hp = Math.min(100, hp+20);
                    else mp = Math.min(100, mp+25);
                    items.splice(i, 1);
                }
            });

            // 자동 공격 이펙트
            if(Date.now() % 600 < 20) {
                bullets.push({ x: player.x, y: player.y, vx: Math.cos(lastDir)*7, vy: Math.sin(lastDir)*7 });
            }

            particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life--; if(p.life<=0) particles.splice(i,1); });
            bullets.forEach((b, i) => { b.x += b.vx; b.y += b.vy; });

            // UI 업데이트
            document.getElementById('hp-bar').style.width = hp + "%";
            document.getElementById('mp-bar').style.width = mp + "%";
            document.getElementById('kill-display').innerText = kills.toString().padStart(3, '0');
            const u = document.getElementById('ult-btn');
            if(mp >= 100) u.classList.add('ready'); else u.classList.remove('ready');

            if(hp <= 0) { alert("Game Over"); location.reload(); }
        }

        // --- 도트 그리기 엔진 ---
        function drawPixel(x, y, size, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x - camera.x, y - camera.y, size, size);
        }

        function draw() {
            ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,canvas.width, canvas.height);
            
            // 배경 격자 (도트 감성)
            ctx.strokeStyle = '#151515';
            for(let i=-camera.x%80; i<canvas.width; i+=80) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
            for(let i=-camera.y%80; i<canvas.height; i+=80) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

            chests.forEach(c => { if(!c.open) drawPixel(c.x-8, c.y-8, 16, '#8b4513'); });
            items.forEach(it => { drawPixel(it.x-4, it.y-4, 8, it.type==='HP'?'#ff0044':'#00a2ff'); });
            enemies.forEach(e => { drawPixel(e.x-6, e.y-6, 12, '#333'); drawPixel(e.x-2, e.y-4, 4, 'red'); });
            bullets.forEach(b => { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(b.x-camera.x, b.y-camera.y, 2, 0, Math.PI*2); ctx.fill(); });
            particles.forEach(p => { ctx.globalAlpha = p.life/20; ctx.fillStyle = p.color; ctx.fillRect(p.x-camera.x, p.y-camera.y, 3, 3); ctx.globalAlpha = 1; });

            // 플레이어 도트 캐릭터
            const px = canvas.width/2, py = canvas.height/2;
            ctx.fillStyle = player.color;
            ctx.fillRect(px-8, py-8, 16, 16); // 몸통
            ctx.fillStyle = 'white'; ctx.fillRect(px-4, py-12, 8, 8); // 머리
            ctx.fillStyle = '#333'; ctx.fillRect(px-2, py-10, 2, 2); // 눈
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
    </script>
</body>
</html>

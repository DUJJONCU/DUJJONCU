<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DooJjonKu Ultimate</title>
    <style>
        * { touch-action: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Courier New', Courier, monospace; color: white; }
        canvas { display: block; }
        #ui-top { position: absolute; top: 10px; width: 100%; padding: 0 20px; display: flex; justify-content: space-between; pointer-events: none; z-index: 10; }
        #bars { display: flex; flex-direction: column; gap: 5px; }
        .bar { width: 120px; height: 8px; border: 1px solid #fff; position: relative; }
        #hp-inner { height: 100%; background: #ff4444; width: 100%; }
        #mp-inner { height: 100%; background: #4444ff; width: 0%; }
        #rank-btn { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); pointer-events: auto; background: none; border: 1px solid gold; color: gold; padding: 5px 10px; cursor: pointer; }
        
        #start-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .class-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .card { border: 1px solid #555; padding: 10px; text-align: center; cursor: pointer; width: 100px; font-size: 12px; }
        .card:hover { border-color: cyan; }

        #joy-base { position: absolute; bottom: 30px; left: 30px; width: 80px; height: 80px; border-radius: 50%; border: 1px solid #333; }
        #joy-stick { position: absolute; top: 20px; left: 20px; width: 40px; height: 40px; background: rgba(0,255,204,0.3); border-radius: 50%; }
        #ult-btn { position: absolute; bottom: 35px; right: 35px; width: 70px; height: 70px; border-radius: 50%; border: 2px solid gold; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: gold; background: rgba(218,165,32,0.1); opacity: 0.3; }
        #ult-btn.active { opacity: 1; box-shadow: 0 0 15px gold; }
    </style>
</head>
<body>
    <div id="start-screen">
        <h2 style="color:cyan">SELECT CLASS</h2>
        <div class="class-grid">
            <div class="card" onclick="start('sword')">ê²€ì‚¬<br>(ê·¼ì ‘)</div>
            <div class="card" onclick="start('arch')">ê¶ìˆ˜<br>(ì›ê±°ë¦¬)</div>
            <div class="card" onclick="start('wiz')">ë²•ì‚¬<br>(ë²”ìœ„)</div>
            <div class="card" onclick="start('wolf')">ëŠ‘ëŒ€<br>(ëœë¤)</div>
            <div class="card" onclick="start('zom')">ì¢€ë¹„<br>(ìƒì¡´)</div>
        </div>
    </div>

    <div id="ui-top">
        <div id="bars">
            <div class="bar"><div id="hp-inner"></div></div>
            <div class="bar"><div id="mp-inner"></div></div>
            <div style="font-size: 10px; margin-top:5px;">LV: <span id="lv">1</span> / STAGE: <span id="st">1</span></div>
        </div>
        <div id="score-ui">KILLS: 0</div>
    </div>
    <button id="rank-btn" onclick="showRank()">RANKING</button>

    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="ult-btn" onclick="useUlt()">ULTIMATE</div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let stage = 1, kills = 0, mp = 0, hp = 100, isPaused = true, score = 0;
        let player, camera, enemies = [], bullets = [], orbs = [], chests = [], items = [];
        let moveX = 0, moveY = 0, isJoy = false, lastAngle = 0;

        const classInfo = {
            sword: { color: '#00ffcc', spd: 1.8, range: 40, ult: 'ì „ì²´ë² ê¸°' },
            arch: { color: '#ffee00', spd: 2.3, range: 250, ult: 'í™”ì‚´ë¹„' },
            wiz: { color: '#ff00ff', spd: 1.5, range: 350, ult: 'ì‹œê°„ì •ì§€' },
            wolf: { color: '#ff8800', spd: 2.5, range: 60, ult: 'ë¬´ì ëŒì§„' },
            zom: { color: '#88ff00', spd: 1.2, range: 100, ult: 'ì¢€ë¹„êµ°ë‹¨' }
        };

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        function start(type) {
            player = { x: 0, y: 0, type, ...classInfo[type], size: 5, maxHp: 100 };
            camera = { x: 0, y: 0 };
            document.getElementById('start-screen').style.display = 'none';
            isPaused = false; loop();
        }

        // --- ì…ë ¥ ë¡œì§ ---
        const joyBase = document.getElementById('joy-base');
        const joyStick = document.getElementById('joy-stick');
        joyBase.addEventListener('touchstart', (e) => { e.preventDefault(); isJoy = true; });
        window.addEventListener('touchmove', (e) => {
            if(!isJoy) return;
            const t = e.touches[0];
            const r = joyBase.getBoundingClientRect();
            const dx = t.clientX - (r.left + 40), dy = t.clientY - (r.top + 40);
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
            const ang = Math.atan2(dy, dx);
            lastAngle = ang;
            joyStick.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
            moveX = (Math.cos(ang)*dist)/40; moveY = (Math.sin(ang)*dist)/40;
        });
        window.addEventListener('touchend', () => { isJoy = false; moveX = 0; moveY = 0; joyStick.style.transform = 'translate(0,0)'; });

        function useUlt() {
            if(mp < 100) return;
            mp = 0; updateUI();
            // í•„ì‚´ê¸° íš¨ê³¼ ì—°ì¶œ (ê°„ëµí™”)
            enemies.forEach(e => e.hp -= 200);
            ctx.fillStyle = "gold"; ctx.fillRect(0,0,canvas.width, canvas.height);
        }

        function updateUI() {
            document.getElementById('hp-inner').style.width = hp + "%";
            document.getElementById('mp-inner').style.width = mp + "%";
            document.getElementById('score-ui').innerText = "KILLS: " + kills;
            const btn = document.getElementById('ult-btn');
            if(mp >= 100) btn.classList.add('active'); else btn.classList.remove('active');
        }

        function loop() {
            if(isPaused) return;
            update(); draw();
            requestAnimationFrame(loop);
        }

        function update() {
            player.x += moveX * player.spd;
            player.y += moveY * player.spd;
            camera.x = player.x - canvas.width/2;
            camera.y = player.y - canvas.height/2;

            // ëª¹ ìŠ¤í° ë° ì§€ëŠ¥í˜• AI (í©ì–´ì¡Œë‹¤ ëª¨ì´ê¸°)
            if(enemies.length < 30) {
                const ang = Math.random() * Math.PI * 2;
                enemies.push({
                    x: player.x + Math.cos(ang)*600,
                    y: player.y + Math.sin(ang)*600,
                    hp: 1 + stage,
                    speed: 0.3 + Math.random()*0.2, // ì•„ì£¼ ì²œì²œíˆ
                    size: 4,
                    offset: Math.random() * 100 // í©ì–´ì§€ê¸° ìœ„í•œ ê°’
                });
            }

            // ìƒì ìŠ¤í°
            if(Math.random() < 0.005 && chests.length < 3) {
                chests.push({x: player.x + (Math.random()-0.5)*800, y: player.y + (Math.random()-0.5)*800, hp: 5});
            }

            enemies.forEach((e, ei) => {
                const dist = Math.hypot(player.x - e.x, player.y - e.y);
                const ang = Math.atan2(player.y - e.y, player.x - e.x);
                // ì•½ê°„ ì§€ê·¸ì¬ê·¸ë¡œ ì˜¤ê²Œ í•˜ì—¬ ìœ ì €ë¥¼ ê´´ë¡­í˜
                const sway = Math.sin(Date.now()*0.002 + e.offset) * 0.5;
                e.x += Math.cos(ang + sway) * e.speed;
                e.y += Math.sin(ang + sway) * e.speed;

                if(dist < 10) hp -= 0.1;
                
                bullets.forEach((b, bi) => {
                    if(Math.hypot(b.x-e.x, b.y-e.y) < 10) {
                        e.hp -= 1; bullets.splice(bi, 1);
                    }
                });

                if(e.hp <= 0) {
                    kills++; mp = Math.min(100, mp + 2);
                    orbs.push({x: e.x, y: e.y});
                    enemies.splice(ei, 1);
                    updateUI();
                }
            });

            // ìƒì íŒŒê´´ ë° ì•„ì´í…œ
            chests.forEach((c, ci) => {
                bullets.forEach((b, bi) => {
                    if(Math.hypot(b.x-c.x, b.y-c.y) < 15) { c.hp -= 1; bullets.splice(bi,1); }
                });
                if(c.hp <= 0) {
                    const r = Math.random();
                    let type = 'hp';
                    if(r > 0.7) type = 'mag'; // ìì„
                    if(r > 0.9) type = 'life'; // ëª©ìˆ¨
                    items.push({x: c.x, y: c.y, type});
                    chests.splice(ci, 1);
                }
            });

            // ì•„ì´í…œ íšë“
            items.forEach((it, i) => {
                if(Math.hypot(player.x-it.x, player.y-it.y) < 20) {
                    if(it.type === 'hp') hp = Math.min(100, hp + 30);
                    if(it.type === 'mag') { /* ëª¨ë“  êµ¬ìŠ¬ playerì—ê²Œ ì´ë™ ë¡œì§ */ }
                    items.splice(i, 1);
                    updateUI();
                }
            });

            // ìë™ ì‚¬ê²© (í´ë˜ìŠ¤ë³„ íŠ¹ì„±ì— ë§ê²Œ)
            if(Date.now() % 500 < 20) {
                bullets.push({x: player.x, y: player.y, vx: Math.cos(lastAngle)*6, vy: Math.sin(lastAngle)*6});
            }

            if(hp <= 0) gameOver();
        }

        function draw() {
            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.strokeStyle = '#111';
            for(let x=-camera.x%50; x<canvas.width; x+=50) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
            for(let y=-camera.y%50; y<canvas.height; y+=50) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }

            enemies.forEach(e => { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(e.x-camera.x, e.y-camera.y, e.size, 0, Math.PI*2); ctx.fill(); });
            bullets.forEach(b => { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(b.x-camera.x, b.y-camera.y, 2, 0, Math.PI*2); ctx.fill(); });
            orbs.forEach(o => { ctx.fillStyle = 'cyan'; ctx.beginPath(); ctx.arc(o.x-camera.x, o.y-camera.y, 1.5, 0, Math.PI*2); ctx.fill(); });
            chests.forEach(c => { ctx.fillStyle = 'brown'; ctx.fillRect(c.x-camera.x-8, c.y-camera.y-8, 16, 16); });
            items.forEach(it => { ctx.fillStyle = it.type==='hp'?'lime':'yellow'; ctx.beginPath(); ctx.arc(it.x-camera.x, it.y-camera.y, 5, 0, Math.PI*2); ctx.fill(); });

            ctx.fillStyle = player.color;
            ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, player.size, 0, Math.PI*2); ctx.fill();
        }

        function gameOver() {
            isPaused = true;
            saveScore(kills);
            alert("GAME OVER! KILLS: " + kills);
            location.reload();
        }

        function saveScore(s) {
            let scores = JSON.parse(localStorage.getItem('dooRank') || "[]");
            scores.push({s, date: new Date().toLocaleDateString()});
            scores.sort((a,b) => b.s - a.s);
            localStorage.setItem('dooRank', JSON.stringify(scores.slice(0, 500)));
        }

        function showRank() {
            let scores = JSON.parse(localStorage.getItem('dooRank') || "[]");
            let msg = scores.slice(0, 10).map((x, i) => `${i+1}. ${x.s}ì `).join('\n');
            alert("ğŸ† TOP 10 RANKING ğŸ†\n" + (msg || "ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."));
        }
    </script>
</body>
</html>

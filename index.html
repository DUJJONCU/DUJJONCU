<!DOCTYPE html>
<html>
<head>
    <title>두쫀쿠 서바이버: 점 버전</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; }
        .stat { font-size: 16px; margin-bottom: 5px; }
        #hpBar { width: 200px; height: 10px; background: #555; border: 1px solid white; }
        #hpInner { height: 100%; width: 100%; background: lime; }
        #levelUp { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                   background: rgba(0,0,0,0.9); padding: 20px; color: white; display: none; text-align: center; }
        .btn { background: #444; color: white; padding: 10px; margin: 5px; cursor: pointer; border: 1px solid #fff; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="stat">시간: <span id="timer">00:00</span></div>
        <div class="stat">레벨: <span id="level">1</span> | 점수: <span id="score">0</span></div>
        <div class="stat">HP <div id="hpBar"><div id="hpInner"></div></div></div>
    </div>

    <div id="levelUp">
        <h2>LEVEL UP! 스킬 선택</h2>
        <div class="btn" onclick="upgrade('gun')">총 (연사/강화)</div>
        <div class="btn" onclick="upgrade('fire')">불 (폭발)</div>
        <div class="btn" onclick="upgrade('water')">물 (주변 공격)</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let score = 0, level = 1, exp = 0, hp = 100, startTime = Date.now(), isPaused = false;
        const player = { x: 0, y: 0, size: 20 };
        const camera = { x: 0, y: 0 };
        const enemies = [], bullets = [], orbs = [];
        const skills = { gun: 1, fire: 0, water: 0 };

        // 적 생성
        setInterval(() => {
            if (isPaused) return;
            const ang = Math.random() * Math.PI * 2;
            const dist = 600;
            const elapsed = (Date.now() - startTime) / 1000;
            enemies.push({
                x: player.x + Math.cos(ang) * dist,
                y: player.y + Math.sin(ang) * dist,
                hp: 2 + Math.floor(elapsed / 30), // 시간 갈수록 피통 커짐
                size: 15,
                color: `hsl(${elapsed * 5 % 360}, 70%, 50%)` // 시간 갈수록 색깔 변함
            });
        }, 800);

        function upgrade(type) {
            skills[type]++;
            isPaused = false;
            document.getElementById('levelUp').style.display = 'none';
        }

        function gameLoop() {
            if (!isPaused) {
                update();
                draw();
            }
            requestAnimationFrame(gameLoop);
        }

        function update() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').innerText = `${Math.floor(elapsed/60)}:${elapsed%60}`;

            // 플레이어는 항상 중앙 (카메라가 따라감)
            camera.x = player.x - canvas.width/2;
            camera.y = player.y - canvas.height/2;

            // 적 추적 및 공격
            enemies.forEach((e, ei) => {
                const ang = Math.atan2(player.y - e.y, player.x - e.x);
                e.x += Math.cos(ang) * 1.5;
                e.y += Math.sin(ang) * 1.5;

                // 플레이어 충돌
                if (Math.hypot(player.x - e.x, player.y - e.y) < player.size + e.size) {
                    hp -= 0.1;
                    document.getElementById('hpInner').style.width = hp + "%";
                }
            });

            // 자동 사격 (가까운 적에게)
            if (Date.now() % 30 === 0 && enemies.length > 0) {
                const target = enemies[0];
                const ang = Math.atan2(target.y - player.y, target.x - player.x);
                bullets.push({ x: player.x, y: player.y, vx: Math.cos(ang) * 7, vy: Math.sin(ang) * 7, size: 4 + skills.gun });
            }

            // 총알 이동
            bullets.forEach((b, bi) => {
                b.x += b.vx; b.y += b.vy;
                enemies.forEach((e, ei) => {
                    if (Math.hypot(b.x - e.x, b.y - e.y) < e.size) {
                        e.hp -= skills.gun;
                        bullets.splice(bi, 1);
                        if (e.hp <= 0) {
                            orbs.push({x: e.x, y: e.y});
                            enemies.splice(ei, 1);
                            score += 10;
                            document.getElementById('score').innerText = score;
                        }
                    }
                });
            });

            // 경험치 획득
            orbs.forEach((o, oi) => {
                if (Math.hypot(player.x - o.x, player.y - o.y) < 30) {
                    orbs.splice(oi, 1);
                    exp++;
                    if (exp >= level * 3) {
                        level++; exp = 0;
                        isPaused = true;
                        document.getElementById('levelUp').style.display = 'block';
                        document.getElementById('level').innerText = level;
                    }
                }
            });

            // 마우스 방향으로 캐릭터 천천히 이동 (필드 누비기)
            // 실제 mattle.fun처럼 마우스 쪽으로 캐릭터 좌표가 바뀝니다.
            // window.onmousemove로 mouseX, mouseY 받아서 구현 가능
        }

        // 키보드 이동 추가
        const keys = {};
        window.onkeydown = e => keys[e.key] = true;
        window.onkeyup = e => keys[e.key] = false;
        function move() {
            if (keys['w'] || keys['ArrowUp']) player.y -= 3;
            if (keys['s'] || keys['ArrowDown']) player.y += 3;
            if (keys['a'] || keys['ArrowLeft']) player.x -= 3;
            if (keys['d'] || keys['ArrowRight']) player.x += 3;
            requestAnimationFrame(move);
        }
        move();

        function draw() {
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 그리드 배경 (이동 체감을 위해)
            ctx.strokeStyle = '#333';
            for(let i=0; i<canvas.width; i+=50) {
                ctx.beginPath(); ctx.moveTo(i - (camera.x % 50), 0); ctx.lineTo(i - (camera.x % 50), canvas.height); ctx.stroke();
            }
            for(let i=0; i<canvas.height; i+=50) {
                ctx.beginPath(); ctx.moveTo(0, i - (camera.y % 50)); ctx.lineTo(canvas.width, i - (camera.y % 50)); ctx.stroke();
            }

            // 적 (색깔 점)
            enemies.forEach(e => {
                ctx.fillStyle = e.color;
                ctx.beginPath(); ctx.arc(e.x - camera.x, e.y - camera.y, e.size, 0, Math.PI*2); ctx.fill();
            });

            // 총알
            bullets.forEach(b => {
                ctx.fillStyle = 'yellow';
                ctx.beginPath(); ctx.arc(b.x - camera.x, b.y - camera.y, b.size, 0, Math.PI*2); ctx.fill();
            });

            // 경험치
            orbs.forEach(o => {
                ctx.fillStyle = 'cyan';
                ctx.beginPath(); ctx.arc(o.x - camera.x, o.y - camera.y, 5, 0, Math.PI*2); ctx.fill();
            });

            // 플레이어 (중앙 고정)
            ctx.fillStyle = '#00ffcc';
            ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, player.size, 0, Math.PI*2); ctx.fill();
        }

        gameLoop();
    </script>
</body>
</html>
